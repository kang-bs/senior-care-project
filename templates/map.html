<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì´ìŒ - ì§€ë„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_key }}"></script>
    <style>
      /* ì‚¬ìš©ì ì •ì˜ í°íŠ¸ ë° ìŠ¤íƒ€ì¼ */
      body {
        font-family: "Noto Sans KR", sans-serif;
      }
      .laundry-gothic {
        font-family: "LaundryGothic", "Noto Sans KR", sans-serif; /* 'LaundryGothic' í°íŠ¸ê°€ ì—†ì„ ê²½ìš° Noto Sans KRë¡œ ëŒ€ì²´ */
      }

      /* ì§€ë„ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
      #map {
        width: 100%;
        height: 100%;
      }

      .info-window {
        padding: 10px;
        width: 220px;
        text-align: left;
        line-height: 1.5;
      }

      .info-window .title {
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 6px;
      }

      .info-window .details {
        font-size: 12px;
        color: #555;
      }

      .info-window button {
        display: block;
        width: 100%;
        margin-top: 8px;
        padding: 6px 0;
        background-color: #ffd600;
        color: #3c1e1e;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
      }

      .info-window button:hover {
        background-color: #e6c200;
      }

      /* í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì• ë‹ˆë©”ì´ì…˜ */
      .current-location-marker {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.7;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* ì–¼êµ´ í† ê¸€ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ */
      :root {
        --toggle-bg: #ffffff;
        --face-color: #64748b;
      }

      body.toggle-active {
        --toggle-bg: #c1e1c1;
        --face-color: #4a5568;
      }

      .toggle-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toggle-text {
        font-size: 1.5rem;
        font-weight: bold;
        color: #1e3a8a;
        transition: color 0.3s;
      }

      .toggle-container.active .toggle-text {
        color: #059669;
      }

      /* ë³µì¡í•œ í† ê¸€ ì• ë‹ˆë©”ì´ì…˜ */
      #face-toggle:checked + label .toggle-handle {
        transform: translateX(24px);
      }

      #face-toggle:checked + label .roller {
        transform: rotate(360deg);
      }

      #face-toggle:checked + label .face-front {
        opacity: 0;
        transition: opacity 0.1s linear 0.5s;
      }

      #face-toggle:checked + label .face-back {
        opacity: 1;
        transition: opacity 0.1s linear 0.5s;
      }

      /* ì–¼êµ´ í‘œì • ì„¸ë¶€ì‚¬í•­ */
      .face-front .eye {
        width: 3px;
        height: 2px;
        top: 10px;
      }
      .face-front .eye.left {
        left: 6px;
      }
      .face-front .eye.right {
        right: 6px;
      }

      .face-front .mouth {
        width: 3.5px;
        height: 3px;
        bottom: 7px;
        left: 50%;
        transform: translateX(-50%);
      }

      .face-back .eye {
        width: 2.5px;
        height: 2.5px;
        top: 10px;
      }
      .face-back .eye.left {
        left: 6.5px;
      }
      .face-back .eye.right {
        right: 6.5px;
      }

      .face-back .mouth {
        width: 3.5px;
        height: 3px;
        bottom: 7px;
        left: 50%;
        transform: translateX(-50%);
        border-bottom: 1px solid var(--face-color);
        border-radius: 50%;
        position: absolute;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="max-w-sm mx-auto bg-white shadow-lg min-h-screen">
      <!-- ìƒë‹¨ ê³ ì • ì˜ì—­ -->
      <div class="sticky top-0 z-10 bg-white shadow-sm">
        <!-- ìƒë‹¨ ë°” -->
        <header class="p-4 flex justify-between items-center">
          <div class="flex items-center">
            <div class="w-8 h-8 mr-2 flex items-center justify-center">
              <img
                src="{{ url_for('static', filename='images/header/logo.png') }}"
                alt="ë¡œê³ "
                class="max-w-full max-h-full object-contain"
              />
            </div>
            <div class="toggle-container" id="toggleContainer">
              <span class="toggle-text" id="toggleText">ì´ìŒ</span>
              <div class="relative w-[50px] h-[26px]">
                <input type="checkbox" id="face-toggle" class="hidden" />
                <label
                  for="face-toggle"
                  class="block w-full h-full cursor-pointer relative border border-gray-300 p-[1.5px] transition-colors duration-500 ease-in-out rounded-[13px]"
                  style="background-color: var(--toggle-bg)"
                >
                  <div
                    class="toggle-handle relative w-[22px] h-[22px] bg-transparent rounded-full transition-transform duration-[600ms] ease-in-out"
                  >
                    <div
                      class="roller relative w-full h-full transition-transform duration-[600ms] ease-in-out"
                    >
                      <!-- ì•ë©´ (ë‚® ëª¨ë“œ) -->
                      <div
                        class="face-front absolute w-full h-full flex justify-center items-center bg-white rounded-full shadow-sm opacity-100 transition-opacity duration-100 linear"
                      >
                        <div
                          class="face-feature eye left absolute border-b-[1px] rounded-full transition-colors duration-500 ease-in-out"
                          style="border-color: var(--face-color)"
                        ></div>
                        <div
                          class="face-feature eye right absolute border-b-[1px] rounded-full transition-colors duration-500 ease-in-out"
                          style="border-color: var(--face-color)"
                        ></div>
                        <div
                          class="face-feature mouth absolute border-b-[1px] rounded-full transition-colors duration-500 ease-in-out"
                          style="border-color: var(--face-color)"
                        ></div>
                      </div>
                      <!-- ë’·ë©´ (ë°¤ ëª¨ë“œ) -->
                      <div
                        class="face-back absolute w-full h-full flex justify-center items-center bg-white rounded-full shadow-sm opacity-0 transition-opacity duration-100 linear"
                      >
                        <div
                          class="face-feature eye left absolute rounded-full transition-colors duration-500 ease-in-out"
                          style="background-color: var(--face-color)"
                        ></div>
                        <div
                          class="face-feature eye right absolute rounded-full transition-colors duration-500 ease-in-out"
                          style="background-color: var(--face-color)"
                        ></div>
                        <div
                          class="face-feature mouth absolute rounded-full transition-colors duration-500 ease-in-out"
                          style="border-color: var(--face-color)"
                        ></div>
                      </div>
                    </div>
                  </div>
                </label>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <div class="w-6 h-6 flex items-center justify-center">
              <img
                src="{{ url_for('static', filename='images/header/mic.png') }}"
                alt="ë§ˆì´í¬"
                class="max-w-full max-h-full object-contain"
              />
            </div>
            <div class="w-6 h-6 flex items-center justify-center">
              <img
                src="{{ url_for('static', filename='images/header/search.png') }}"
                alt="ê²€ìƒ‰"
                class="max-w-full max-h-full object-contain"
              />
            </div>
          </div>
        </header>
      </div>

      <!-- ë©”ì¸ ì»¨í…ì¸ : ì§€ë„ -->
      <main class="bg-white" style="height: calc(100vh - 129px)">
        <div id="map" aria-label="ì¼ìë¦¬ ì§€ë„"></div>
      </main>

      <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
      <footer
        class="fixed bottom-0 left-0 right-0 max-w-sm mx-auto bg-gray-50 border-t flex justify-around"
      >
        <a
          href="{{ url_for('map.show_map') }}"
          class="flex-1 flex flex-col items-center justify-center p-2 text-blue-900"
        >
          <div class="w-6 h-6 mb-1 flex items-center justify-center">
            <img
              src="{{ url_for('static', filename='images/footer/map_filled.png') }}"
              alt="ì§€ë„"
              class="max-w-full max-h-full object-contain"
            />
          </div>
          <span class="text-xs font-bold">ì§€ë„</span>
        </a>
        <a
          href="{{ url_for('jobs.bookmark_list') }}"
          class="flex-1 flex flex-col items-center justify-center p-2 text-gray-500"
        >
          <div class="w-6 h-6 mb-1 flex items-center justify-center">
            <img
              src="{{ url_for('static', filename='images/footer/favorite.png') }}"
              alt="ì°œ"
              class="max-w-full max-h-full object-contain"
            />
          </div>
          <span class="text-xs">ì°œ</span>
        </a>
        <a
          href="{{ url_for('auth.main') }}"
          class="flex-1 flex flex-col items-center justify-center p-2 text-gray-500"
        >
          <div class="w-6 h-6 mb-1 flex items-center justify-center">
            <img
              src="{{ url_for('static', filename='images/footer/home.png') }}"
              alt="í™ˆ"
              class="max-w-full max-h-full object-contain"
            />
          </div>
          <span class="text-xs">í™ˆ</span>
        </a>
        <a
          href="{{ url_for('chat.chat_list') }}"
          class="flex-1 flex flex-col items-center justify-center p-2 text-gray-500"
        >
          <div class="w-6 h-6 mb-1 flex items-center justify-center">
            <img
              src="{{ url_for('static', filename='images/footer/chatting.png') }}"
              alt="ì±„íŒ…"
              class="max-w-full max-h-full object-contain"
            />
          </div>
          <span class="text-xs">ì±„íŒ…</span>
        </a>
        <a
          href="{{ url_for('auth.profile') }}"
          class="flex-1 flex flex-col items-center justify-center p-2 text-gray-500"
        >
          <div class="w-6 h-6 mb-1 flex items-center justify-center">
            <img
              src="{{ url_for('static', filename='images/footer/profile.png') }}"
              alt="ë‚´ì •ë³´"
              class="max-w-full max-h-full object-contain"
            />
          </div>
          <span class="text-xs">ë‚´ì •ë³´</span>
        </a>
      </footer>
    </div>

    <script>
      // DOM
      const container = document.getElementById("map");

      // ìƒíƒœ
      let map = null;
      const markers = [];
      let currentLocationMarker = null; // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤
      const infoWindow = new kakao.maps.InfoWindow({ removable: true }); // ë‹¨ì¼ ì¬ì‚¬ìš©

      // ìœ í‹¸: ì•ˆì „ ìˆ«ì ë³€í™˜
      const toNumber = (v) => {
        const n = Number(v);
        return Number.isFinite(n) ? n : NaN;
      };

      // ìœ í‹¸: ì¸í¬ìœˆë„ìš° ë‚´ë¶€ onclick íŒŒë¼ë¯¸í„°ì— ë„£ì„ ë¬¸ìì—´ ì´ìŠ¤ì¼€ì´í”„
      const escapeForAttr = (s) => String(s ?? "").replace(/'/g, "\\'");

      // ë§ˆì»¤ ìƒì„±
      function createMarker(position, title) {
        return new kakao.maps.Marker({ position, map, title: title ?? "" });
      }

      // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ìƒì„±
      function createCurrentLocationMarker(position) {
        // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ìš© ì»¤ìŠ¤í…€ ì´ë¯¸ì§€ ìƒì„± (ë” ëˆˆì— ë„ëŠ” ë””ìì¸)
        const imageSrc =
          "data:image/svg+xml;base64," +
          btoa(`
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="16" cy="16" r="14" fill="#4285f4" fill-opacity="0.3"/>
            <circle cx="16" cy="16" r="10" fill="#4285f4" fill-opacity="0.5"/>
            <circle cx="16" cy="16" r="6" fill="#4285f4"/>
            <circle cx="16" cy="16" r="3" fill="white"/>
            <circle cx="16" cy="16" r="1.5" fill="#4285f4"/>
          </svg>
        `);
        const imageSize = new kakao.maps.Size(32, 32);
        const imageOption = { offset: new kakao.maps.Point(16, 16) };
        const markerImage = new kakao.maps.MarkerImage(
          imageSrc,
          imageSize,
          imageOption
        );

        return new kakao.maps.Marker({
          position,
          map,
          title: "ğŸ“ ë‚´ í˜„ì¬ ìœ„ì¹˜",
          image: markerImage,
        });
      }

      // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì—…ë°ì´íŠ¸ (ì •í™•ë„ ì •ë³´ í¬í•¨)
      function updateCurrentLocation(position, accuracy = null) {
        if (currentLocationMarker) {
          currentLocationMarker.setMap(null);
        }
        currentLocationMarker = createCurrentLocationMarker(position);

        // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ í´ë¦­ ì‹œ ì¸í¬ìœˆë„ìš° (ì •í™•ë„ ì •ë³´ í¬í•¨)
        kakao.maps.event.addListener(currentLocationMarker, "click", () => {
          const accuracyText = accuracy
            ? `ì •í™•ë„: ${Math.round(accuracy)}m`
            : "ì •í™•ë„: ì¸¡ì • ì¤‘...";
          const statusColor =
            accuracy < 50 ? "#4CAF50" : accuracy < 100 ? "#FF9800" : "#F44336";

          const content = `
            <div class="info-window">
              <div class="title">ğŸ“ ë‚´ í˜„ì¬ ìœ„ì¹˜</div>
              <div class="details">í˜„ì¬ ìˆëŠ” ìœ„ì¹˜ì…ë‹ˆë‹¤</div>
              <div class="details" style="color: ${statusColor}; font-weight: 600;">
                ${accuracyText}
              </div>
              <div class="details" style="font-size: 11px; color: #888; margin-top: 4px;">
                ${
                  accuracy < 50
                    ? "ğŸŸ¢ ë§¤ìš° ì •í™•"
                    : accuracy < 100
                    ? "ğŸŸ¡ ë³´í†µ ì •í™•"
                    : "ğŸ”´ ì •í™•ë„ ë‚®ìŒ"
                }
              </div>
            </div>
          `;
          infoWindow.setContent(content);
          infoWindow.open(map, currentLocationMarker);
        });
      }

      // ë„¤ë¹„ê²Œì´ì…˜ í˜¸ì¶œ(ëª¨ë°”ì¼: ì¹´ì¹´ì˜¤ë‚´ë¹„, PC: ì¹´ì¹´ì˜¤ë§µ ê¸¸ì°¾ê¸°)
      function navigateTo(lat, lng, name) {
        const safeName = encodeURIComponent(name ?? "");
        const isMobile = /Mobi/i.test(navigator.userAgent);

        if (isMobile) {
          const url = `kakaonavi-sdk://navigate?destination=${safeName}&x=${lng}&y=${lat}&coord_type=wgs84`;
          window.location.href = url;
        } else {
          const url = `https://map.kakao.com/link/to/${safeName},${lat},${lng}`;
          window.open(url, "_blank", "noopener,noreferrer");
        }
      }
      window.navigateTo = navigateTo; // ì¸í¬ìœˆë„ìš° ë²„íŠ¼ì—ì„œ í˜¸ì¶œ

      // ê¸°ì¡´ ë§ˆì»¤ ì œê±° (í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ëŠ” ìœ ì§€)
      function clearMarkers() {
        for (const m of markers) m.setMap(null);
        markers.length = 0;
      }

      // ì¸í¬ìœˆë„ìš° í…œí”Œë¦¿
      function buildInfoContent(job) {
        const title = job.title ?? "";
        const company = job.company || "ì •ë³´ ì—†ìŒ";
        const salary =
          typeof job.salary === "number"
            ? job.salary.toLocaleString("ko-KR") + "ì›"
            : job.salary || "í˜‘ì˜";

        const lat = toNumber(job.lat);
        const lng = toNumber(job.lng);

        return `
        <div class="info-window">
          <div class="title">${title}</div>
          <div class="details">íšŒì‚¬ëª…: ${company}</div>
          <div class="details">ê¸‰ì—¬: ${salary}</div>
          <button onclick="navigateTo(${lat}, ${lng}, '${escapeForAttr(
          title
        )}')">ê¸¸ì°¾ê¸°</button>
        </div>
      `;
      }

      // ë°ì´í„° ë¡œë“œ ë° ë§ˆì»¤ ë Œë”ë§
      async function loadAllJobs() {
        try {
          const res = await fetch("/jobs_all", { credentials: "same-origin" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          clearMarkers();
          infoWindow.close();

          const jobs = Array.isArray(data?.jobs) ? data.jobs : [];
          if (jobs.length === 0) {
            console.log("í‘œì‹œí•  ì¼ìë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          for (const job of jobs) {
            const lat = toNumber(job.lat);
            const lng = toNumber(job.lng);
            if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

            const pos = new kakao.maps.LatLng(lat, lng);
            const marker = createMarker(pos, job.title);

            kakao.maps.event.addListener(marker, "click", () => {
              infoWindow.setContent(buildInfoContent(job));
              infoWindow.open(map, marker);
            });

            markers.push(marker);
          }
        } catch (err) {
          console.error("ì¼ìë¦¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
          alert("ì¼ìë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì§€ë„ ìƒì„± ê³µí†µ
      function createMapAndLoad(center, userLocation = null, accuracy = null) {
        map = new kakao.maps.Map(container, { center, level: 7 });
        loadAllJobs(); // ìƒì„± ì§í›„ ë¡œë“œ

        // ì‚¬ìš©ì ìœ„ì¹˜ê°€ ìˆë‹¤ë©´ í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ
        if (userLocation) {
          updateCurrentLocation(userLocation, accuracy);
          startLocationTracking(); // ìœ„ì¹˜ ì¶”ì  ì‹œì‘
        }
      }

      // ìœ„ì¹˜ ì¶”ì  ì‹œì‘ (ë” ì •í™•í•œ ì„¤ì •)
      function startLocationTracking() {
        if (!navigator.geolocation) {
          console.warn("ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }

        // ê¶Œí•œ ìƒíƒœ í™•ì¸
        if (navigator.permissions) {
          navigator.permissions
            .query({ name: "geolocation" })
            .then((result) => {
              console.log("ìœ„ì¹˜ ê¶Œí•œ ìƒíƒœ:", result.state);
            });
        }

        // watchPositionìœ¼ë¡œ ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  (ë” ì •í™•í•¨)
        const watchId = navigator.geolocation.watchPosition(
          (pos) => {
            const accuracy = pos.coords.accuracy; // ì •í™•ë„ ë¯¸í„° ë‹¨ìœ„
            const speed = pos.coords.speed; // ì†ë„ (m/s)
            const timestamp = new Date(pos.timestamp);

            console.log(
              `ìœ„ì¹˜ ì—…ë°ì´íŠ¸: ì •í™•ë„ ${Math.round(
                accuracy
              )}m, ì‹œê°„ ${timestamp.toLocaleTimeString()}`
            );
            if (speed !== null) {
              console.log(`ì´ë™ ì†ë„: ${Math.round(speed * 3.6)}km/h`);
            }

            // ì •í™•ë„ê°€ ë„ˆë¬´ ë‚®ìœ¼ë©´ ì—…ë°ì´íŠ¸ í•˜ì§€ ì•ŠìŒ (1000m ì´ìƒ)
            if (accuracy > 1000) {
              console.warn("ìœ„ì¹˜ ì •í™•ë„ê°€ ë‚®ì•„ ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
              return;
            }

            const position = new kakao.maps.LatLng(
              pos.coords.latitude,
              pos.coords.longitude
            );
            updateCurrentLocation(position, accuracy); // ì •í™•ë„ ì •ë³´ ì „ë‹¬

            // ì •í™•ë„ê°€ ì¢‹ê±°ë‚˜ ì²˜ìŒ ìœ„ì¹˜ë¥¼ ë°›ì•˜ì„ ë•Œ ì§€ë„ ì¤‘ì‹¬ ì´ë™
            if ((accuracy < 200 && map) || !currentLocationMarker) {
              map.setCenter(position);
            }
          },
          (err) => {
            console.error("ìœ„ì¹˜ ì¶”ì  ì˜¤ë¥˜:", err);
            let errorMsg = "";
            switch (err.code) {
              case err.PERMISSION_DENIED:
                errorMsg =
                  "ìœ„ì¹˜ ì•¡ì„¸ìŠ¤ê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.";
                break;
              case err.POSITION_UNAVAILABLE:
                errorMsg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                break;
              case err.TIMEOUT:
                errorMsg = "ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.";
                break;
            }
            console.warn(errorMsg);
          },
          {
            enableHighAccuracy: true, // ê³ ì •ë°€ë„ GPS ì‚¬ìš©
            timeout: 10000, // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
            maximumAge: 1000, // 1ì´ˆ ì´ë‚´ì˜ ìºì‹œëœ ìœ„ì¹˜ ì‚¬ìš©
          }
        );

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ìœ„ì¹˜ ì¶”ì  ì¤‘ë‹¨
        window.addEventListener("beforeunload", () => {
          navigator.geolocation.clearWatch(watchId);
        });
      }

      // ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­ ë° ì´ˆê¸°í™”
      async function requestLocationPermission() {
        if (!navigator.geolocation) {
          console.warn("ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return false;
        }

        // ê¶Œí•œ APIë¥¼ ì§€ì›í•˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ê¶Œí•œ ìƒíƒœ í™•ì¸
        if (navigator.permissions) {
          try {
            const permission = await navigator.permissions.query({
              name: "geolocation",
            });
            console.log("í˜„ì¬ ìœ„ì¹˜ ê¶Œí•œ ìƒíƒœ:", permission.state);

            if (permission.state === "denied") {
              alert(
                "ìœ„ì¹˜ ì„œë¹„ìŠ¤ê°€ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì™¼ìª½ì˜ ìë¬¼ì‡  ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”."
              );
              return false;
            }
          } catch (e) {
            console.log("ê¶Œí•œ API ì§€ì›í•˜ì§€ ì•ŠìŒ");
          }
        }

        return true;
      }

      // ì´ˆê¸°í™”: í˜„ì¬ ìœ„ì¹˜ ì„±ê³µ ì‹œ ê·¸ ì¢Œí‘œë¡œ, ì‹¤íŒ¨ ì‹œ í´ë°±
      async function initMap() {
        const fallback = new kakao.maps.LatLng(37.5665, 126.978); // ì„œìš¸ ì‹œì²­

        // ìœ„ì¹˜ ê¶Œí•œ í™•ì¸
        const hasLocationPermission = await requestLocationPermission();
        if (!hasLocationPermission) {
          createMapAndLoad(fallback);
          return;
        }

        // ì‚¬ìš©ìì—ê²Œ ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­ ì•ˆë‚´
        console.log("ì •í™•í•œ ìœ„ì¹˜ ì •ë³´ë¥¼ ìœ„í•´ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const accuracy = pos.coords.accuracy;
            console.log(`ì´ˆê¸° ìœ„ì¹˜ ì •í™•ë„: ${accuracy}m`);
            console.log(
              `ìœ„ë„: ${pos.coords.latitude}, ê²½ë„: ${pos.coords.longitude}`
            );

            const center = new kakao.maps.LatLng(
              pos.coords.latitude,
              pos.coords.longitude
            );
            createMapAndLoad(center, center, accuracy); // í˜„ì¬ ìœ„ì¹˜ì™€ ì •í™•ë„ ì •ë³´ ì „ë‹¬

            // ì •í™•ë„ ì•Œë¦¼
            if (accuracy > 100) {
              console.warn(
                `ìœ„ì¹˜ ì •í™•ë„ê°€ ë‚®ìŠµë‹ˆë‹¤ (${accuracy}m). WiFië‚˜ GPSë¥¼ í™œì„±í™”í•˜ë©´ ë” ì •í™•í•œ ìœ„ì¹˜ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
              );
            }
          },
          (err) => {
            console.error("ì´ˆê¸° ìœ„ì¹˜ ì •ë³´ ì˜¤ë¥˜:", err);
            let errorMsg =
              "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ì„œìš¸ ì‹œì²­ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.";

            switch (err.code) {
              case err.PERMISSION_DENIED:
                errorMsg =
                  "ìœ„ì¹˜ ì•¡ì„¸ìŠ¤ê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.";
                alert(errorMsg);
                break;
              case err.POSITION_UNAVAILABLE:
                errorMsg =
                  "ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPSë‚˜ WiFië¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
                break;
              case err.TIMEOUT:
                errorMsg =
                  "ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
                break;
            }
            console.warn(errorMsg);
            createMapAndLoad(fallback);
          },
          {
            enableHighAccuracy: true, // ê³ ì •ë°€ë„ GPS ì‚¬ìš©
            timeout: 15000, // 15ì´ˆ íƒ€ì„ì•„ì›ƒ (ì´ˆê¸°í™”ëŠ” ë” ê¸¸ê²Œ)
            maximumAge: 0, // ìºì‹œ ì‚¬ìš© ì•ˆí•¨ (ìµœì‹  ìœ„ì¹˜ í•„ìš”)
          }
        );
      }

      // ë¶€íŠ¸ìŠ¤íŠ¸ë©
      initMap();

      // ì–¼êµ´ í† ê¸€ ìŠ¤ìœ„ì¹˜ ìƒíƒœ ê´€ë¦¬
      let isToggleActive = false;

      // í† ê¸€ ìŠ¤ìœ„ì¹˜ ê¸°ëŠ¥
      function updateToggleTheme() {
        const toggle = document.getElementById("face-toggle");
        const body = document.body;
        const container = document.getElementById("toggleContainer");
        const toggleText = document.getElementById("toggleText");

        if (toggle.checked) {
          body.classList.add("toggle-active");
          container.classList.add("active");
          isToggleActive = true;

          // 1ì´ˆ í›„ì— í† ê¸€ í˜ì´ì§€ë¡œ ì´ë™ (ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„)
          setTimeout(() => {
            window.location.href = "/toggle-page";
          }, 1000);
        } else {
          body.classList.remove("toggle-active");
          container.classList.remove("active");
          isToggleActive = false;
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", function () {
        const toggle = document.getElementById("face-toggle");
        const urlParams = new URLSearchParams(window.location.search);

        // reset_toggle íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ í† ê¸€ì„ ë¹„í™œì„±í™” ìƒíƒœë¡œ ì„¤ì •
        if (urlParams.get("reset_toggle") === "true") {
          toggle.checked = false;
          updateToggleTheme();
        }

        // í† ê¸€ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        toggle.addEventListener("change", updateToggleTheme);

        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        updateToggleTheme();
      });
    </script>
  </body>
</html>
