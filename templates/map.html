<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>기본 마커 + 커스텀 오버레이로 위치 구분</title>
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_key }}"></script>
  <style>
    html, body, #map {
      height: 100%; margin: 0; padding: 0; box-sizing: border-box;
    }
    #map { width: 100vw; height: 100vh; }
    .custom-label {
      color: white;
      background-color: rgba(0,0,0,0.7);
      padding: 2px 6px;
      font-size: 12px;
      border-radius: 3px;
      white-space: nowrap;
      user-select: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    var container = document.getElementById('map');
    var map;
    var markers = [];
    var overlays = [];

    function clearMarkersAndOverlays() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
      overlays.forEach(overlay => overlay.setMap(null));
      overlays = [];
    }

    // 기본 빨간 마커 생성
    function createDefaultMarker(position, title) {
      return new kakao.maps.Marker({
        position: position,
        map: map,
        title: title
      });
    }

    // 마커 위에 텍스트 라벨(커스텀 오버레이) 생성
    function createLabelOverlay(position, text) {
      var content = document.createElement('div');
      content.className = 'custom-label';
      content.innerText = text;

      return new kakao.maps.CustomOverlay({
        position: position,
        content: content,
        yAnchor: 1  // 마커 위쪽에 붙도록
      });
    }

    // 전체 일자리 마커 + 라벨 출력
    function loadAllJobs() {
      fetch('/jobs_all')
        .then(res => res.json())
        .then(data => {
          clearMarkersAndOverlays();

          if (!data.jobs || data.jobs.length === 0) {
            console.log('표시할 일자리가 없습니다.');
            return;
          }

          data.jobs.forEach(job => {
            const lat = parseFloat(job.lat);
            const lng = parseFloat(job.lng);
            if (isNaN(lat) || isNaN(lng)) return;

            var position = new kakao.maps.LatLng(lat, lng);
            var marker = createDefaultMarker(position, job.title);
            var overlay = createLabelOverlay(position, '일자리');
            overlay.setMap(map);

            markers.push(marker);
            overlays.push(overlay);

            var infowindow = new kakao.maps.InfoWindow({
              content: `<div style="padding:5px;">${job.title}</div>`
            });
            marker.addListener('click', () => infowindow.open(map, marker));
          });
        })
        .catch(err => {
          console.error('일자리 데이터 불러오기 실패:', err);
          alert('일자리를 불러오는 중 오류가 발생했습니다.');
        });
    }

    // 지도 초기화 및 내 위치 마커+라벨 표시
    function initMap() {
      var defaultPosition = new kakao.maps.LatLng(37.5665, 126.9780);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var userPosition = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);

          map = new kakao.maps.Map(container, {
            center: userPosition,
            level: 7
          });

          var userMarker = createDefaultMarker(userPosition, '현재 위치');
          var userLabel = createLabelOverlay(userPosition, '내 위치');
          userLabel.setMap(map);

          loadAllJobs();

        }, function(error) {
          console.error('위치 정보 오류:', error);

          map = new kakao.maps.Map(container, {
            center: defaultPosition,
            level: 7
          });

          loadAllJobs();
        });
      } else {
        map = new kakao.maps.Map(container, {
          center: defaultPosition,
          level: 7
        });

        loadAllJobs();
      }
    }

    initMap();
  </script>
</body>
</html>
