<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ job.title }} - 기업이음</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f8f9fa;
        max-width: 480px;
        margin: 0 auto;
        padding-bottom: 80px;
      }

      /* 헤더 */
      .header {
        background: white;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .back-btn {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #333;
      }

      .header-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }

      .header-actions {
        display: flex;
        gap: 10px;
      }

      .action-btn {
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
        color: #666;
      }

      /* 메인 컨텐츠 */
      .job-detail {
        background: white;
        margin: 20px;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .job-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
        margin-bottom: 20px;
        position: relative;
      }

      .company-badge {
        position: absolute;
        top: 0;
        right: 0;
        background: #e67e22;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .company-info {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
      }

      .company-logo {
        width: 60px;
        height: 60px;
        background: #e9ecef;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #666;
      }

      .company-details h2 {
        font-size: 18px;
        color: #333;
        margin-bottom: 5px;
      }

      .company-name {
        font-size: 14px;
        color: #666;
      }

      .job-title {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
      }

      .job-meta {
        display: flex;
        gap: 15px;
        font-size: 14px;
        color: #666;
      }

      /* 상세 정보 섹션 */
      .detail-section {
        margin-bottom: 25px;
      }

      .section-title {
        font-size: 16px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid #e67e22;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
      }

      .info-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
      }

      .info-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
      }

      .info-value {
        font-size: 14px;
        color: #333;
        font-weight: 500;
      }

      .salary-highlight {
        background: #e8f5e8;
        color: #27ae60;
        font-weight: bold;
        font-size: 18px;
      }

      /* 근무 요일 */
      .work-days {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .day-badge {
        background: #e67e22;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
      }

      .day-badge.inactive {
        background: #e9ecef;
        color: #6c757d;
      }

      /* 설명 */
      .description {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        line-height: 1.6;
        color: #333;
        white-space: pre-wrap;
      }

      /* 통계 정보 */
      .job-stats {
        display: flex;
        justify-content: space-around;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-top: 20px;
      }

      .stat-item {
        text-align: center;
      }

      .stat-number {
        font-size: 18px;
        font-weight: bold;
        color: #e67e22;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      /* 액션 버튼 */
      .action-buttons {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 480px;
        background: white;
        padding: 15px 20px;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 10px;
      }

      .btn-bookmark {
        background: #f8f9fa;
        border: 1px solid #ddd;
        padding: 12px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .btn-apply {
        flex: 1;
        background: #e67e22;
        color: white;
        border: none;
        padding: 15px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
      }

      .btn-apply:hover {
        background: #d35400;
      }

      /* 작성자 액션 */
      .author-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .btn-edit,
      .btn-delete {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        font-size: 14px;
      }

      .btn-edit {
        background: #f8f9fa;
        color: #333;
      }

      .btn-delete {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
      }

      .btn-applications {
        background: #e67e22;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
        display: inline-block;
        margin-bottom: 10px;
      }

      .created-date {
        font-size: 12px;
        color: #999;
        text-align: right;
        margin-top: 15px;
      }

      .applications-summary {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 15px;
        margin-top: 20px;
      }

      .applications-summary h4 {
        color: #856404;
        margin-bottom: 10px;
      }

      .applications-summary p {
        color: #856404;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <!-- 헤더 -->
    <div class="header">
      <button class="back-btn" onclick="history.back()">←</button>
      <div class="header-title">기업 공고 상세</div>
      <div class="header-actions">
        <button class="action-btn">⋯</button>
      </div>
    </div>

    <!-- 공고 상세 정보 -->
    <div class="job-detail">
      <!-- 헤더 정보 -->
      <div class="job-header">
        <div class="company-badge">기업</div>
        <div class="company-info">
          <div class="company-logo">
            {{ job.company[0] if job.company else '기' }}
          </div>
          <div class="company-details">
            <h2>{{ job.company }}</h2>
            <div class="company-name">기업 회원</div>
          </div>
        </div>
        <div class="job-title">{{ job.title }}</div>
        <div class="job-meta">
          <span>조회 {{ job.view_count }}</span>
          <span>찜 {{ job.bookmark_count }}</span>
          <span>지원 {{ job.application_count }}</span>
        </div>
      </div>

      <!-- 기본 정보 -->
      <div class="detail-section">
        <div class="section-title">기본 정보</div>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">모집 형태</div>
            <div class="info-value">
              {{ job.recruitment_type or '미정' }} {% if job.recruitment_type ==
              '일용직' and job.work_period %}
              <span
                style="
                  margin-left: 8px;
                  padding: 2px 8px;
                  background: #e8f5e8;
                  color: #27ae60;
                  border-radius: 12px;
                  font-size: 12px;
                "
                >{{ job.work_period }}</span
              >
              {% endif %}
            </div>
          </div>
          <div class="info-item {% if job.salary %}salary-highlight{% endif %}">
            <div class="info-label">급여</div>
            <div class="info-value">{{ job.salary or '협의' }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">모집 인원</div>
            <div class="info-value">
              {{ job.recruitment_count or '미정' }}명
            </div>
          </div>
          <div class="info-item">
            <div class="info-label">근무 지역</div>
            <div class="info-value">{{ job.region or '협의' }}</div>
          </div>
        </div>
      </div>

      <!-- 근무 조건 -->
      <div class="detail-section">
        <div class="section-title">근무 조건</div>

        {% if job.work_start_time or job.work_end_time %}
        <div class="info-item" style="margin-bottom: 15px">
          <div class="info-label">근무 시간</div>
          <div class="info-value">
            {% if job.work_start_time %}{{ job.work_start_time.strftime('%H:%M')
            }}{% else %}시작시간 미정{% endif %} ~ {% if job.work_end_time %}{{
            job.work_end_time.strftime('%H:%M') }}{% else %}종료시간 미정{%
            endif %}
          </div>
        </div>
        {% endif %}

        <div class="info-item">
          <div class="info-label">근무 요일</div>
          <div class="work-days">
            <span
              class="day-badge {% if not job.work_monday %}inactive{% endif %}"
              >월</span
            >
            <span
              class="day-badge {% if not job.work_tuesday %}inactive{% endif %}"
              >화</span
            >
            <span
              class="day-badge {% if not job.work_wednesday %}inactive{% endif %}"
              >수</span
            >
            <span
              class="day-badge {% if not job.work_thursday %}inactive{% endif %}"
              >목</span
            >
            <span
              class="day-badge {% if not job.work_friday %}inactive{% endif %}"
              >금</span
            >
            <span
              class="day-badge {% if not job.work_saturday %}inactive{% endif %}"
              >토</span
            >
            <span
              class="day-badge {% if not job.work_sunday %}inactive{% endif %}"
              >일</span
            >
          </div>
        </div>
      </div>

      <!-- 상세 설명 -->
      <div class="detail-section">
        <div class="section-title">상세 설명</div>
        <div class="description">{{ job.description }}</div>
      </div>

      <!-- 연락처 -->
      {% if job.contact_phone %}
      <div class="detail-section">
        <div class="section-title">연락처</div>
        <div class="info-item">
          <div class="info-label">전화번호</div>
          <div class="info-value">{{ job.contact_phone }}</div>
        </div>
      </div>
      {% endif %}

      <!-- 통계 -->
      <div class="job-stats">
        <div class="stat-item">
          <div class="stat-number">{{ job.view_count }}</div>
          <div class="stat-label">조회수</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ job.bookmark_count }}</div>
          <div class="stat-label">찜</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ job.application_count }}</div>
          <div class="stat-label">지원</div>
        </div>
      </div>

      <!-- 작성자 전용 액션 -->
      {% if current_user.id == job.author_id %}
      <div class="applications-summary">
        <h4>📋 지원자 관리</h4>
        <p>현재 {{ job.application_count }}명이 지원했습니다.</p>
        <a
          href="{{ url_for('company.company_job_applications', job_id=job.id) }}"
          class="btn-applications"
        >
          지원자 목록 보기
        </a>
      </div>

      <div class="author-actions">
        <a href="{{ url_for('jobs.edit_job', job_id=job.id) }}" class="btn-edit"
          >수정하기</a
        >
        <form
          method="POST"
          action="{{ url_for('jobs.delete_job', job_id=job.id) }}"
          style="flex: 1"
          onsubmit="return confirm('정말 삭제하시겠습니까?')"
        >
          <button
            type="submit"
            class="btn-delete"
            style="width: 100%; border: none"
          >
            삭제하기
          </button>
        </form>
      </div>
      {% endif %}

      <div class="created-date">
        {{ job.created_at.strftime('%Y년 %m월 %d일 %H:%M') }} 등록
      </div>
    </div>

    <!-- 액션 버튼 (일반 사용자만) -->
    {% if current_user.user_type == 0 %}
    <div class="action-buttons">
      <button
        class="btn-bookmark"
        onclick="toggleBookmark()"
        style="color: {% if is_bookmarked %}#e74c3c{% else %}#666{% endif %};"
      >
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
          />
        </svg>
      </button>
      {% if application_status.applied %}
      <button
        class="btn-apply"
        style="background: #28a745"
        onclick="goToChatFromDetail()"
      >
        채팅하기
      </button>
      {% else %}
      <button class="btn-apply" onclick="applyJob()">지원하기</button>
      {% endif %}
    </div>
    {% endif %}

    <script>
      function toggleBookmark() {
        const bookmarkBtn = document.querySelector('.btn-bookmark');
        const jobId = {{ job.id }};

        fetch(`/jobs/${jobId}/bookmark`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            if (data.is_bookmarked) {
              bookmarkBtn.style.color = '#e74c3c';
            } else {
              bookmarkBtn.style.color = '#666';
            }

            // 통계 업데이트
            const bookmarkStat = document.querySelector('.stat-item:nth-child(2) .stat-number');
            if (bookmarkStat) {
              bookmarkStat.textContent = data.bookmark_count;
            }
          } else {
            alert(data.message || '오류가 발생했습니다.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('오류가 발생했습니다.');
        });
      }

      async function applyJob() {
        if (!confirm("이 공고에 지원하시겠습니까?\n지원하면 자동으로 채팅방이 생성됩니다.")) {
          return;
        }

        const applyBtn = document.querySelector('.btn-apply');
        const originalText = applyBtn.textContent;

        try {
          applyBtn.disabled = true;
          applyBtn.textContent = '지원 중...';

          const response = await fetch(`/jobs/{{ job.id }}/apply`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: ''
            })
          });

          const data = await response.json();

          if (data.success) {
            alert(data.message);

            // 지원 통계 업데이트
            const applicationStat = document.querySelector('.stat-item:nth-child(3) .stat-number');
            if (applicationStat) {
              applicationStat.textContent = parseInt(applicationStat.textContent) + 1;
            }

            // 채팅방으로 이동할지 묻기
            if (data.chat_room_id && confirm('채팅방으로 이동하시겠습니까?')) {
              window.location.href = `/chat/${data.chat_room_id}`;
            } else {
              // 지원하기 버튼을 채팅하기 버튼으로 변경
              applyBtn.textContent = '채팅하기';
              applyBtn.style.background = '#28a745';
              applyBtn.onclick = function() {
                window.location.href = `/chat/${data.chat_room_id}`;
              };
            }
          } else {
            alert(data.message || '지원 중 오류가 발생했습니다.');
            applyBtn.disabled = false;
            applyBtn.textContent = originalText;
          }
        } catch (error) {
          console.error('Error:', error);
          alert('지원 중 오류가 발생했습니다.');
          applyBtn.disabled = false;
          applyBtn.textContent = originalText;
        }
      }

      // 채팅방으로 이동하는 함수 (상세 페이지용)
      async function goToChatFromDetail() {
        try {
          const response = await fetch(`/chat/find-room/{{ job.id }}`, {
            method: 'GET'
          });

          const data = await response.json();

          if (data.success && data.room_id) {
            window.location.href = `/chat/${data.room_id}`;
          } else {
            alert('채팅방을 찾을 수 없습니다.');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('채팅방 이동 중 오류가 발생했습니다.');
        }
      }
    </script>
  </body>
</html>
