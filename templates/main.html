<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>이음 - 시니어 일자리리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* 사용자 정의 폰트 및 스타일 */
      body {
        font-family: "Noto Sans KR", sans-serif;
      }
      .laundry-gothic {
        font-family: "LaundryGothic", "Noto Sans KR", sans-serif; /* 'LaundryGothic' 폰트가 없을 경우 Noto Sans KR로 대체 */
      }
      /* 얼굴 토글 스위치 스타일 */
      :root {
        --toggle-bg: #FFFFFF;
        --face-color: #64748B;
      }

      body.toggle-active {
        --toggle-bg: #C1E1C1;
        --face-color: #4A5568;
      }

      .toggle-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toggle-text {
        font-size: 1.5rem;
        font-weight: bold;
        color: #1e3a8a;
        transition: color 0.3s;
      }

      .toggle-container.active .toggle-text {
        color: #059669;
      }

      /* 복잡한 토글 애니메이션 */
      #face-toggle:checked + label .toggle-handle {
        transform: translateX(24px);
      }

      #face-toggle:checked + label .roller {
        transform: rotate(360deg);
      }
      
      #face-toggle:checked + label .face-front {
        opacity: 0;
        transition: opacity 0.1s linear 0.5s;
      }

      #face-toggle:checked + label .face-back {
        opacity: 1;
        transition: opacity 0.1s linear 0.5s;
      }

      /* 얼굴 표정 세부사항 */
      .face-front .eye {
        width: 3px;
        height: 2px;
        top: 10px;
      }
      .face-front .eye.left { left: 6px; }
      .face-front .eye.right { right: 6px; }

      .face-front .mouth {
        width: 3.5px;
        height: 3px;
        bottom: 7px;
        left: 50%;
        transform: translateX(-50%);
      }

      .face-back .eye {
        width: 2.5px;
        height: 2.5px;
        top: 10px;
      }
      .face-back .eye.left { left: 6.5px; }
      .face-back .eye.right { right: 6.5px; }

      .face-back .mouth {
        width: 3.5px;
        height: 3px;
        bottom: 7px;
        left: 50%;
        transform: translateX(-50%);
        border-bottom: 1px solid var(--face-color);
        border-radius: 50%;
        position: absolute;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="w-full bg-white shadow-lg min-h-screen">
      <!-- 상단 고정 영역 -->
      <div class="sticky top-0 z-10 bg-white shadow-sm">
        <!-- 상단 바 -->
        <header class="px-4 py-3 sm:px-6 flex justify-between items-center">
          <div class="flex items-center">
            <div class="w-8 h-8 mr-2 flex items-center justify-center">
              <img
                src="{{ url_for('static', filename='images/header/logo.png') }}"
                alt="로고"
                class="max-w-full max-h-full object-contain"
              />
            </div>
            <div class="toggle-container" id="toggleContainer">
              <span class="toggle-text" id="toggleText">이음</span>
              <div class="relative w-[50px] h-[26px]">
                <input type="checkbox" id="face-toggle" class="hidden">
                <label for="face-toggle" class="block w-full h-full cursor-pointer relative border border-gray-300 p-[1.5px] transition-colors duration-500 ease-in-out rounded-[13px]" style="background-color: var(--toggle-bg);">
                  <div class="toggle-handle relative w-[22px] h-[22px] bg-transparent rounded-full transition-transform duration-[600ms] ease-in-out">
                    <div class="roller relative w-full h-full transition-transform duration-[600ms] ease-in-out">
                      <!-- 앞면 (낮 모드) -->
                      <div class="face-front absolute w-full h-full flex justify-center items-center bg-white rounded-full shadow-sm opacity-100 transition-opacity duration-100 linear">
                        <div class="face-feature eye left absolute border-b-[1px] rounded-full transition-colors duration-500 ease-in-out" style="border-color: var(--face-color);"></div>
                        <div class="face-feature eye right absolute border-b-[1px] rounded-full transition-colors duration-500 ease-in-out" style="border-color: var(--face-color);"></div>
                        <div class="face-feature mouth absolute border-b-[1px] rounded-full transition-colors duration-500 ease-in-out" style="border-color: var(--face-color);"></div>
                      </div>
                      <!-- 뒷면 (밤 모드) -->
                      <div class="face-back absolute w-full h-full flex justify-center items-center bg-white rounded-full shadow-sm opacity-0 transition-opacity duration-100 linear">
                        <div class="face-feature eye left absolute rounded-full transition-colors duration-500 ease-in-out" style="background-color: var(--face-color);"></div>
                        <div class="face-feature eye right absolute rounded-full transition-colors duration-500 ease-in-out" style="background-color: var(--face-color);"></div>
                        <div class="face-feature mouth absolute rounded-full transition-colors duration-500 ease-in-out" style="border-color: var(--face-color);"></div>
                      </div>
                    </div>
                  </div>
                </label>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-3 sm:space-x-4">
            <div class="w-6 h-6 flex items-center justify-center">
              <img
                src="{{ url_for('static', filename='images/header/mic.png') }}"
                alt="마이크"
                class="max-w-full max-h-full object-contain"
              />
            </div>
            <div class="w-6 h-6 flex items-center justify-center">
              <img
                src="{{ url_for('static', filename='images/header/search.png') }}"
                alt="검색"
                class="max-w-full max-h-full object-contain"
              />
            </div>
          </div>
        </header>

        <!-- 네비게이션 탭 -->
        <nav class="flex border-b">
          <a
            href="#"
            class="flex-1 text-center py-3 border-b-4 border-blue-900 text-blue-900 font-bold"
            >나의 이음</a
          >
          <a
            href="{{ url_for('company.company_list') }}"
            class="flex-1 text-center py-3 text-gray-500"
            >기업 이음</a
          >
          <a
            href="{{ url_for('jobs.job_list') }}"
            class="flex-1 text-center py-3 text-gray-500"
            >사람 이음</a
          >
        </nav>
      </div>

      <!-- 메인 컨텐츠 -->
      <main class="px-4 py-4 sm:px-6 bg-white pb-24">
        <!-- 환영 메시지 -->
        <section class="my-8">
          <h1
            class="text-2xl sm:text-3xl font-bold text-blue-900 leading-tight laundry-gothic"
          >
            {{ user.nickname or user.name }}님,<br />
            건강도 챙기면서<br />
            일할 수 있는 기회예요!
          </h1>
        </section>

        <!-- 날씨 정보 -->
        <section class="mb-6">
          <div class="flex items-center bg-gray-100 rounded-full p-2">
            <div class="flex items-center">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 text-yellow-500"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm0 14a1 1 0 01-1 1v1a1 1 0 112 0v-1a1 1 0 01-1-1zM5.293 5.293a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zm9.193 9.193a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM3 10a1 1 0 01-1 1H1a1 1 0 110-2h1a1 1 0 011 1zm9.707-4.707a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zm-9.193 9.193a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM10 5a5 5 0 100 10 5 5 0 000-10z"
                  clip-rule="evenodd"
                />
              </svg>
              <span class="ml-2 text-sm font-medium">맑음 / 20°C</span>
            </div>
            <div class="ml-4 text-sm text-gray-500 flex items-center">
              <span>조영동</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 ml-1"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </div>
          </div>
        </section>

        <!-- ✅ 관리자 전용 승인관리 버튼 -->
        {% if current_user.user_type == 2 %}
        <div
          style="
            padding: 15px;
            background: #fff;
            margin: 10px;
            border-radius: 8px;
          "
        >
          <a
            href="{{ url_for('admin.pending_companies') }}"
            style="
              display: block;
              background: #3498db;
              color: white;
              text-align: center;
              padding: 12px;
              border-radius: 6px;
              font-weight: bold;
              text-decoration: none;
            "
          >
            기업회원 승인/거부 페이지
          </a>
        </div>
        {% endif %}

        <!-- 추천 기업 이음 -->
        <section class="mb-8">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">추천 기업 이음</h2>
            <a
              href="{{ url_for('company.company_list') }}"
              class="text-sm text-gray-500"
              >더보기 ></a
            >
          </div>
          <div class="space-y-4">
            {% if company_jobs %} {% for job_data in company_jobs %} {% set job
            = job_data.job %} {% set status = job_data.application_status %}
            <div
              class="bg-white p-4 rounded-lg border cursor-pointer"
              onclick="location.href='{{ url_for('company.company_job_detail', job_id=job.id) }}'"
            >
              <div class="flex items-start justify-between">
                <div class="flex items-start">
                  <div
                    class="w-10 h-10 bg-gray-200 rounded-full mr-3 flex items-center justify-center text-gray-600 font-bold"
                  >
                    {{ job.company[0] if job.company else '기' }}
                  </div>
                  <div>
                    <p class="text-sm text-gray-600">{{ job.company }}</p>
                    <h3 class="font-bold text-lg">{{ job.title }}</h3>
                    <p class="text-gray-800">{{ job.salary or '급여 협의' }}</p>
                  </div>
                </div>
                <p class="text-xs text-gray-500">
                  {{ job.created_at.strftime('~%m/%d') }}
                </p>
              </div>
              <div class="flex items-center justify-between mt-4">
                <div class="flex space-x-2">
                  {% if job.recruitment_type %}
                  <span
                    class="bg-gray-200 text-gray-700 text-xs font-semibold px-2.5 py-1 rounded-full"
                  >
                    {{ job.recruitment_type }}
                  </span>
                  {% endif %} {% if job.work_period %}
                  <span
                    class="bg-gray-200 text-gray-700 text-xs font-semibold px-2.5 py-1 rounded-full"
                  >
                    {{ job.work_period }}
                  </span>
                  {% endif %}
                </div>
                {% if current_user.user_type == 0 %} {% if status.applied %}
                <button
                  class="bg-green-500 text-white font-bold py-2 px-6 rounded-full"
                  onclick="event.stopPropagation(); goToChat({{ job.id }})"
                >
                  채팅하기
                </button>
                {% else %}
                <button
                  class="bg-blue-900 text-white font-bold py-2 px-6 rounded-full"
                  onclick="event.stopPropagation(); applyJob({{ job.id }})"
                >
                  지원하기
                </button>
                {% endif %} {% elif current_user.user_type == 1 %} {% if
                current_user.id == job.author_id %}
                <button
                  class="bg-gray-400 text-white font-bold py-2 px-6 rounded-full cursor-not-allowed"
                  disabled
                >
                  내 공고
                </button>
                {% else %}
                <button
                  class="bg-gray-400 text-white font-bold py-2 px-6 rounded-full cursor-not-allowed"
                  disabled
                >
                  타 기업 공고
                </button>
                {% endif %} {% else %}
                <button
                  class="bg-gray-400 text-white font-bold py-2 px-6 rounded-full cursor-not-allowed"
                  disabled
                >
                  관리자 계정
                </button>
                {% endif %}
              </div>
            </div>
            {% endfor %} {% else %}
            <div
              class="bg-white p-4 rounded-lg border text-center text-gray-500"
            >
              <p>등록된 기업 공고가 없습니다.</p>
            </div>
            {% endif %}
          </div>
        </section>

        <!-- 실시간 사람 이음 -->
        <section>
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">실시간 사람 이음</h2>
            <a
              href="{{ url_for('jobs.job_list') }}"
              class="text-sm text-gray-500"
              >더보기 ></a
            >
          </div>
          <div class="space-y-4">
            {% if people_jobs %} {% for job_data in people_jobs %} {% set job =
            job_data.job %} {% set status = job_data.application_status %}
            <div
              class="bg-white p-4 rounded-lg border cursor-pointer"
              onclick="location.href='{{ url_for('jobs.job_detail', job_id=job.id) }}'"
            >
              <div class="flex items-start justify-between">
                <div class="flex items-start">
                  <div
                    class="w-10 h-10 bg-gray-200 rounded-full mr-3 flex items-center justify-center text-gray-600 font-bold"
                  >
                    {{ job.author.nickname[0] if job.author.nickname else '사'
                    }}
                  </div>
                  <div>
                    <p class="text-sm text-gray-600">
                      {{ job.author.nickname }} ({{ job.company }})
                    </p>
                    <h3 class="font-bold text-lg">{{ job.title }}</h3>
                    <p class="text-gray-800">{{ job.salary or '급여 협의' }}</p>
                  </div>
                </div>
                <p class="text-xs text-gray-500">
                  {{ job.created_at.strftime('~%m/%d') }}
                </p>
              </div>
              <div class="flex items-center justify-between mt-4">
                <div class="flex space-x-2">
                  {% if job.recruitment_type %}
                  <span
                    class="bg-gray-200 text-gray-700 text-xs font-semibold px-2.5 py-1 rounded-full"
                  >
                    {{ job.recruitment_type }}
                  </span>
                  {% endif %} {% if job.work_period %}
                  <span
                    class="bg-gray-200 text-gray-700 text-xs font-semibold px-2.5 py-1 rounded-full"
                  >
                    {{ job.work_period }}
                  </span>
                  {% endif %}
                </div>
                {% if current_user.user_type == 0 %} {% if current_user.id ==
                job.author_id %}
                <button
                  class="bg-gray-400 text-white font-bold py-2 px-6 rounded-full cursor-not-allowed"
                  disabled
                >
                  내 공고
                </button>
                {% elif status.applied %}
                <button
                  class="bg-green-500 text-white font-bold py-2 px-6 rounded-full"
                  onclick="event.stopPropagation(); goToChat({{ job.id }})"
                >
                  채팅하기
                </button>
                {% else %}
                <button
                  class="bg-blue-900 text-white font-bold py-2 px-6 rounded-full"
                  onclick="event.stopPropagation(); applyJob({{ job.id }})"
                >
                  지원하기
                </button>
                {% endif %} {% elif current_user.user_type == 1 %}
                <button
                  class="bg-gray-400 text-white font-bold py-2 px-6 rounded-full cursor-not-allowed"
                  disabled
                >
                  기업 계정
                </button>
                {% else %}
                <button
                  class="bg-gray-400 text-white font-bold py-2 px-6 rounded-full cursor-not-allowed"
                  disabled
                >
                  관리자 계정
                </button>
                {% endif %}
              </div>
            </div>
            {% endfor %} {% else %}
            <div
              class="bg-white p-4 rounded-lg border text-center text-gray-500"
            >
              <p>등록된 사람 이음 공고가 없습니다.</p>
            </div>
            {% endif %}
          </div>
        </section>
      </main>

      <!-- 하단 네비게이션 -->
      <footer
        class="fixed bottom-0 left-0 right-0 w-full bg-gray-50 border-t flex justify-around"
      >
        <a href="{{ url_for('map.show_map') }}" class="flex-1 flex flex-col items-center justify-center p-2 text-gray-500">
            <div class="w-6 h-6 mb-1 flex items-center justify-center">
                <img src="{{ url_for('static', filename='images/footer/map.png') }}" alt="지도" class="max-w-full max-h-full object-contain" />
            </div>
            <span class="text-xs">지도</span>
        </a>
        <a
          href="{{ url_for('jobs.bookmark_list') }}"
          class="flex-1 flex flex-col items-center justify-center p-2 text-gray-500"
        >
          <div class="w-6 h-6 mb-1 flex items-center justify-center">
            <img
              src="{{ url_for('static', filename='images/footer/favorite.png') }}"
              alt="찜"
              class="max-w-full max-h-full object-contain"
            />
          </div>
          <span class="text-xs">찜</span>
        </a>
        <a
          href="{{ url_for('auth.main') }}"
          class="flex-1 flex flex-col items-center justify-center p-2 text-blue-900"
        >
          <div class="w-6 h-6 mb-1 flex items-center justify-center">
            <img
              src="{{ url_for('static', filename='images/footer/home_filled.png') }}"
              alt="홈"
              class="max-w-full max-h-full object-contain"
            />
          </div>
          <span class="text-xs font-bold">홈</span>
        </a>
        <a
          href="{{ url_for('chat.chat_list') }}"
          class="flex-1 flex flex-col items-center justify-center p-2 text-gray-500"
        >
          <div class="w-6 h-6 mb-1 flex items-center justify-center">
            <img
              src="{{ url_for('static', filename='images/footer/chatting.png') }}"
              alt="채팅"
              class="max-w-full max-h-full object-contain"
            />
          </div>
          <span class="text-xs">채팅</span>
        </a>
        <a
          href="{{ url_for('auth.profile') }}"
          class="flex-1 flex flex-col items-center justify-center p-2 text-gray-500"
        >
          <div class="w-6 h-6 mb-1 flex items-center justify-center">
            <img
              src="{{ url_for('static', filename='images/footer/profile.png') }}"
              alt="내정보"
              class="max-w-full max-h-full object-contain"
            />
          </div>
          <span class="text-xs">내정보</span>
        </a>
      </footer>
    </div>
    <script>
      // 공고 지원하기 함수
      async function applyJob(jobId) {
        if (
          !confirm(
            "이 공고에 지원하시겠습니까?\n지원하면 자동으로 채팅방이 생성됩니다."
          )
        ) {
          return;
        }
        try {
          const response = await fetch(`/jobs/${jobId}/apply`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: "" }),
          });
          const data = await response.json();
          if (data.success) {
            alert(data.message);
            if (data.chat_room_id && confirm("채팅방으로 이동하시겠습니까?")) {
              window.location.href = `/chat/${data.chat_room_id}`;
            } else {
              location.reload();
            }
          } else {
            alert(data.message || "지원 중 오류가 발생했습니다.");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("지원 중 오류가 발생했습니다.");
        }
      }

      // 채팅방으로 이동하는 함수
      async function goToChat(jobId) {
        try {
          const response = await fetch(`/chat/find-room/${jobId}`, {
            method: "GET",
          });
          const data = await response.json();
          if (data.success && data.room_id) {
            window.location.href = `/chat/${data.room_id}`;
          } else {
            alert("채팅방을 찾을 수 없습니다.");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("채팅방 이동 중 오류가 발생했습니다.");
        }
      }

      // 얼굴 토글 스위치 상태 관리
      let isToggleActive = false;

      // 토글 스위치 기능
      function updateToggleTheme() {
        const toggle = document.getElementById('face-toggle');
        const body = document.body;
        const container = document.getElementById('toggleContainer');
        const toggleText = document.getElementById('toggleText');
        
        if (toggle.checked) {
          body.classList.add('toggle-active');
          container.classList.add('active');
          isToggleActive = true;
          
          // 1초 후에 토글 페이지로 이동 (애니메이션 완료 후)
          setTimeout(() => {
            window.location.href = '/toggle-page';
          }, 1000);
        } else {
          body.classList.remove('toggle-active');
          container.classList.remove('active');
          isToggleActive = false;
        }
      }

      // 페이지 로드 시 초기화
      document.addEventListener('DOMContentLoaded', function() {
        const toggle = document.getElementById('face-toggle');
        const urlParams = new URLSearchParams(window.location.search);
        
        // reset_toggle 파라미터가 있으면 토글을 비활성화 상태로 설정
        if (urlParams.get('reset_toggle') === 'true') {
          toggle.checked = false;
          updateToggleTheme();
        }
        
        // 토글 변경 이벤트 리스너 추가
        toggle.addEventListener('change', updateToggleTheme);
        
        // 초기 상태 설정
        updateToggleTheme();
      });
    </script>
  </body>
</html>
