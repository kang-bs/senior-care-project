<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>이력서 작성/수정</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; background-color: #f9f9f9; }
        .form-container { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .step-container { border: 1px solid #ddd; padding: 20px; margin-top: 20px; border-radius: 8px; }
        h1 { text-align: center; color: #333; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #444; }
        h4 { color: #555; margin-top: 20px; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; }
        input[type="text"], input[type="time"], input[type="number"], textarea { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        textarea { min-height: 120px; resize: vertical; }
        .button-group { margin-top: 25px; display: flex; justify-content: space-between; }
        button { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button[type="submit"] { background-color: #007bff; color: white; width: 100%; }
        .prev-btn { background-color: #6c757d; color: white; }
        .next-btn { background-color: #28a745; color: white; }
        .certificate-entry { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .checkbox-group label { display: inline-block; margin-right: 15px; font-weight: normal; }
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

    <div class="form-container">
        <h1>이력서 관리</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" enctype="multipart/form-data">
            <!-- 단계 1: 희망 직무 분야 및 형태 -->
            <div id="step-1" class="step-container">
                <h2>1. 희망 근무 조건</h2>
                <h4>희망 직무분야 (중복 선택 가능)</h4>
                <div class="checkbox-group">
                    {% for category in all_categories %}
                    <label>
                        <input type="checkbox" name="categories" value="{{ category.value }}" {% if resume and category.value in (resume.desired_categories or "") %}checked{% endif %}>
                        {{ category.value }}
                    </label>
                    {% endfor %}
                </div>

                <h4>희망 근무 형태</h4>
                <div class="checkbox-group">
                    {% for work_type in all_work_types %}
                    <label>
                        <input type="radio" name="desired_work_type" value="{{ work_type.name }}" {% if resume and resume.desired_work_type == work_type %}checked{% endif %}>
                        {{ work_type.value }}
                    </label>
                    {% endfor %}
                </div>
                <div class="button-group">
                    <button type="button" class="next-btn" onclick="nextStep(2)">다음</button>
                </div>
            </div>

            <!-- 단계 2 ~ 4 (이전 코드와 동일, 생략 없이 전체 포함) -->
            <div id="step-2" class="step-container" style="display:none;">
                <h2>2. 희망 근무 요일 및 시간</h2>
                <h4>희망 근무 요일</h4>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="work_monday" {% if resume and resume.work_monday %}checked{% endif %}> 월</label>
                    <label><input type="checkbox" name="work_tuesday" {% if resume and resume.work_tuesday %}checked{% endif %}> 화</label>
                    <label><input type="checkbox" name="work_wednesday" {% if resume and resume.work_wednesday %}checked{% endif %}> 수</label>
                    <label><input type="checkbox" name="work_thursday" {% if resume and resume.work_thursday %}checked{% endif %}> 목</label>
                    <label><input type="checkbox" name="work_friday" {% if resume and resume.work_friday %}checked{% endif %}> 금</label>
                    <label><input type="checkbox" name="work_saturday" {% if resume and resume.work_saturday %}checked{% endif %}> 토</label>
                    <label><input type="checkbox" name="work_sunday" {% if resume and resume.work_sunday %}checked{% endif %}> 일</label>
                </div>
                <h4>희망 근무 시간</h4>
                <div>
                    <label>시작 시간: <input type="time" id="start_time" name="start_time" value="{{ resume.desired_start_time.strftime('%H:%M') if resume and resume.desired_start_time }}"></label>
                    <label>종료 시간: <input type="time" id="end_time" name="end_time" value="{{ resume.desired_end_time.strftime('%H:%M') if resume and resume.desired_end_time }}"></label>
                    <label><input type="checkbox" id="time_negotiable" name="is_time_negotiable" {% if resume and resume.is_time_negotiable %}checked{% endif %}> 시간 협의 가능</label>
                </div>
                <div class="button-group">
                    <button type="button" class="prev-btn" onclick="prevStep(1)">이전</button>
                    <button type="button" class="next-btn" onclick="nextStep(3)">다음</button>
                </div>
            </div>

            <div id="step-3" class="step-container" style="display:none;">
                <h2>3. 경력 및 자격증</h2>
                <label>경험 및 경력
                    <textarea name="experience">{{ resume.experience or '' }}</textarea>
                </label>

                <h4>자격증</h4>
                <div id="existing-certificates-list">
                    {% if resume and resume.certificates %}
                        <p><b>현재 등록된 자격증:</b> (X를 누르면 즉시 삭제됩니다)</p>
                        {% for cert in resume.certificates %}
                            <div class="existing-cert-item">
                                <span>{{ cert.name }} - <a href="{{ cert.image_url }}" target="_blank">이미지 보기</a></span>
                                <button type="button" class="delete-cert-btn" onclick="deleteCertificate({{ cert.id }}, this)">X</button>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- 새로운 자격증이 동적으로 추가될 컨테이너 -->
                <div id="certificates-container"></div>

                <button type="button" onclick="addCertificateField()">+ 자격증 추가</button>
                <div class="button-group">
                    <button type="button" class="prev-btn" onclick="prevStep(2)">이전</button>
                    <button type="button" class="next-btn" onclick="nextStep(4)">다음</button>
                </div>
            </div>

            <div id="step-4" class="step-container" style="display:none;">
                <h2>4. 개인 특성 및 신체 정보</h2>
                <h4>나의 성격 및 강점</h4>
                <div class="checkbox-group">
                    {% for strength in all_strengths %}
                    <label>
                        <input type="checkbox" name="strengths" value="{{ strength.value }}" {% if resume and strength.value in (resume.strengths or '') %}checked{% endif %}>
                        {{ strength.value }}
                    </label>
                    {% endfor %}
                </div>

                <label>쉬지 않고 걸을 수 있는 시간 (분)
                    <input type="number" name="walkable_minutes" value="{{ resume.walkable_minutes or '' }}" placeholder="예: 30">
                </label>
                <label>나의 신체적 특징
                    <textarea name="physical_notes" placeholder="예: 장시간 서서 근무는 어려움">{{ resume.physical_notes or '' }}</textarea>
                </label>
                <label>이동 가능 시간 (분)
                    <input type="number" name="commute_time" value="{{ resume.commute_time or '' }}" placeholder="예: 60">
                </label>
                <div class="button-group">
                    <button type="button" class="prev-btn" onclick="prevStep(3)">이전</button>
                    <button type="button" class="next-btn" onclick="nextStep(5)">다음</button>
                </div>
            </div>

            <!-- 단계 5: 자기소개 및 최종 제출 -->
            <div id="step-5" class="step-container" style="display:none;">
                <h2>5. 자기소개 및 최종 제출</h2>
                <label>자기소개
                    <textarea name="self_introduction">{{ resume.self_introduction or '' }}</textarea>
                </label>
                <label>
                    <input type="checkbox" name="is_public" {% if resume and resume.is_public %}checked{% endif %}>
                    기업에게 이력서 공개하기
                </label>
                <div class="button-group">
                    <button type="button" class="prev-btn" onclick="prevStep(4)">이전</button>
                    <button type="submit">이력서 저장하기</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        let currentStep = 1;
        function showStep(step) { document.querySelectorAll('.step-container').forEach(el => el.style.display = 'none'); document.getElementById(`step-${step}`).style.display = 'block'; }
        function nextStep(step) { currentStep = step; showStep(step); }
        function prevStep(step) { currentStep = step; showStep(step); }
        function addCertificateField() {
            const container = document.getElementById('certificates-container');
            const newEntry = document.createElement('div');
            newEntry.className = 'certificate-entry';

            // 입력 필드와 함께 'X' 삭제 버튼을 생성합니다.
            // 이 버튼의 onclick 이벤트는 자신의 부모 요소(newEntry)를 DOM에서 제거합니다.
            newEntry.innerHTML = `
                <input type="text" name="certificate_names" placeholder="자격증 이름" required style="flex: 1;">
                <input type="file" name="certificate_images" required style="flex: 2;">
                <button type="button" class="delete-cert-btn" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(newEntry);
        }
        const timeNegotiable = document.getElementById('time_negotiable'), startTime = document.getElementById('start_time'), endTime = document.getElementById('end_time');
        function toggleTime() { const d = timeNegotiable.checked; startTime.disabled = d; endTime.disabled = d; if (d) { startTime.value = ''; endTime.value = ''; } }
        timeNegotiable.addEventListener('change', toggleTime);
        document.addEventListener('DOMContentLoaded', () => { showStep(1); toggleTime(); });
        function deleteCertificate(certId, buttonElement) {
            if (!confirm('정말로 이 자격증을 영구적으로 삭제하시겠습니까?')) {
                return;
            }

            fetch(`/resume/certificate/delete/${certId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    buttonElement.closest('.existing-cert-item').remove();
                    alert('자격증이 성공적으로 삭제되었습니다.');
                } else {
                    alert('삭제에 실패했습니다: ' + (data.message || '서버 오류'));
                }
            })
            .catch(error => {
                console.error('삭제 요청 중 오류 발생:', error);
                alert('삭제 처리 중 오류가 발생했습니다.');
            });
        }

    </script>

</body>
</html>
