{% extends "base.html" %} {% block title %}AI 채용공고 작성 도우미{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
          <i class="fas fa-robot text-primary"></i> AI 채용공고 작성 도우미
        </h2>
        <div>
          <button class="btn btn-outline-secondary" onclick="loadTemplate()">
            <i class="fas fa-file-alt"></i> 템플릿 불러오기
          </button>
          <button class="btn btn-outline-info" onclick="validateData()">
            <i class="fas fa-check-circle"></i> 검증하기
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- 입력 폼 -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">
          <h5><i class="fas fa-edit"></i> 채용 정보 입력</h5>
        </div>
        <div class="card-body">
          <form id="jobForm">
            <!-- 기본 정보 -->
            <div class="mb-3">
              <label class="form-label"
                >채용 제목 <span class="text-danger">*</span></label
              >
              <input
                type="text"
                class="form-control"
                id="title"
                placeholder="예: 매장 고객 안내"
              />
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label"
                  >고용 형태 <span class="text-danger">*</span></label
                >
                <select class="form-select" id="employment_type">
                  <option value="">선택하세요</option>
                  <option value="정규직">정규직</option>
                  <option value="계약직">계약직</option>
                  <option value="파트타임">파트타임</option>
                  <option value="알바">알바</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label"
                  >근무 지역 <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="location"
                  placeholder="예: 서울 송파구 잠실"
                />
              </div>
            </div>

            <!-- 근무 조건 -->
            <div class="card mb-3">
              <div class="card-header">
                <h6>근무 조건</h6>
              </div>
              <div class="card-body">
                <div class="row mb-3">
                  <div class="col-md-4">
                    <label class="form-label">근무 요일</label>
                    <input
                      type="text"
                      class="form-control"
                      id="schedule_days"
                      placeholder="예: 주3일"
                    />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">시작 시간</label>
                    <input
                      type="time"
                      class="form-control"
                      id="schedule_start"
                    />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">종료 시간</label>
                    <input type="time" class="form-control" id="schedule_end" />
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-4">
                    <label class="form-label">급여 형태</label>
                    <select class="form-select" id="pay_type">
                      <option value="negotiable">협의</option>
                      <option value="hourly">시급</option>
                      <option value="daily">일급</option>
                      <option value="monthly">월급</option>
                      <option value="yearly">연봉</option>
                    </select>
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">급여 금액</label>
                    <div class="input-group">
                      <input
                        type="number"
                        class="form-control"
                        id="pay_amount"
                        placeholder="예: 12000"
                      />
                      <span class="input-group-text">원</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 업무 내용 -->
            <div class="mb-3">
              <label class="form-label"
                >주요 업무 <span class="text-danger">*</span></label
              >
              <textarea
                class="form-control"
                id="duties"
                rows="3"
                placeholder="예: 고객응대, 안내데스크, 간단 정리정돈"
              ></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">자격 요건 / 우대 사항</label>
              <textarea
                class="form-control"
                id="requirements"
                rows="2"
                placeholder="예: 기본 컴퓨터 사용, 서비스 경험 우대"
              ></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">복리후생</label>
              <textarea
                class="form-control"
                id="benefits"
                rows="2"
                placeholder="예: 식사 제공, 유니폼 지급, 4대보험"
              ></textarea>
            </div>

            <!-- 지원 정보 -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">지원 방법</label>
                <input
                  type="text"
                  class="form-control"
                  id="apply"
                  value="채용 플랫폼 내 지원"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">마감일</label>
                <input
                  type="text"
                  class="form-control"
                  id="deadline"
                  value="채용 시 마감"
                />
              </div>
            </div>

            <!-- 추가 정보 -->
            <div class="card mb-3">
              <div class="card-header">
                <h6>추가 정보</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="training_provided"
                      />
                      <label class="form-check-label" for="training_provided">
                        교육 제공
                      </label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="flexible_time"
                      />
                      <label class="form-check-label" for="flexible_time">
                        시간 조정 가능
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-grid">
              <button
                type="button"
                class="btn btn-primary btn-lg"
                onclick="generateJobPost()"
              >
                <i class="fas fa-magic"></i> AI로 채용공고 생성하기
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 결과 출력 -->
    <div class="col-lg-6">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5><i class="fas fa-file-text"></i> 생성된 채용공고</h5>
          <button
            class="btn btn-sm btn-outline-primary"
            onclick="copyToClipboard()"
            id="copyBtn"
            style="display: none"
          >
            <i class="fas fa-copy"></i> 복사
          </button>
        </div>
        <div class="card-body">
          <div
            id="loadingSpinner"
            style="display: none"
            class="text-center py-5"
          >
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">생성 중...</span>
            </div>
            <p class="mt-2">AI가 채용공고를 작성하고 있습니다...</p>
          </div>

          <div id="resultContainer" style="display: none">
            <div class="mb-3">
              <h6>제목</h6>
              <div class="p-2 bg-light rounded" id="generatedTitle"></div>
            </div>

            <div class="mb-3">
              <h6>핵심 요약</h6>
              <div
                class="p-2 bg-light rounded"
                id="generatedSummary"
                style="white-space: pre-line"
              ></div>
            </div>

            <div class="mb-3">
              <h6>상세 설명</h6>
              <div
                class="p-3 border rounded"
                id="generatedDescription"
                style="white-space: pre-line"
              ></div>
            </div>

            <div class="mb-3">
              <h6>해시태그</h6>
              <div id="generatedHashtags"></div>
            </div>

            <div class="mb-3">
              <small class="text-muted">
                <i class="fas fa-info-circle"></i>
                생성 시간: <span id="generatedTime"></span> | 글자 수:
                <span id="wordCount"></span>자
              </small>
            </div>
          </div>

          <div id="emptyState" class="text-center py-5 text-muted">
            <i class="fas fa-robot fa-3x mb-3"></i>
            <p>
              좌측 폼을 작성하고 "AI로 채용공고 생성하기" 버튼을 클릭하세요.
            </p>
          </div>
        </div>
      </div>

      <!-- 검증 결과 -->
      <div class="card mt-3" id="validationCard" style="display: none">
        <div class="card-header">
          <h6><i class="fas fa-check-circle"></i> 검증 결과</h6>
        </div>
        <div class="card-body">
          <div class="mb-2">
            <strong
              >점수:
              <span id="validationScore" class="badge bg-success">100</span
              >/100</strong
            >
          </div>
          <div id="validationIssues"></div>
          <div id="validationSuggestions"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 템플릿 선택 모달 -->
<div class="modal fade" id="templateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">채용공고 템플릿 선택</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div id="templateList"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // AI 채용공고 생성
  async function generateJobPost() {
    const formData = collectFormData();

    // 필수 필드 검증
    if (
      !formData.title ||
      !formData.employment_type ||
      !formData.location ||
      !formData.duties
    ) {
      alert("필수 필드를 모두 입력해주세요.");
      return;
    }

    // 로딩 표시
    document.getElementById("loadingSpinner").style.display = "block";
    document.getElementById("resultContainer").style.display = "none";
    document.getElementById("emptyState").style.display = "none";

    try {
      const response = await fetch("/api/job-draft", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formData),
      });

      const result = await response.json();

      if (result.success) {
        displayResult(result);
      } else {
        alert("생성 실패: " + result.error);
        if (result.fallback_template) {
          displayFallback(result.fallback_template);
        }
      }
    } catch (error) {
      alert("서버 오류: " + error.message);
    } finally {
      document.getElementById("loadingSpinner").style.display = "none";
    }
  }

  // 폼 데이터 수집
  function collectFormData() {
    const formData = {
      title: document.getElementById("title").value.trim(),
      employment_type: document.getElementById("employment_type").value,
      location: document.getElementById("location").value.trim(),
      duties: document.getElementById("duties").value.trim(),
      requirements: document.getElementById("requirements").value.trim(),
      benefits: document.getElementById("benefits").value.trim(),
      apply: document.getElementById("apply").value.trim(),
      deadline: document.getElementById("deadline").value.trim(),
      training_provided: document.getElementById("training_provided").checked,
      flexible_time: document.getElementById("flexible_time").checked,
    };

    // 근무 일정
    const scheduleDays = document.getElementById("schedule_days").value.trim();
    const scheduleStart = document.getElementById("schedule_start").value;
    const scheduleEnd = document.getElementById("schedule_end").value;

    if (scheduleDays || scheduleStart || scheduleEnd) {
      formData.schedule = {};
      if (scheduleDays) formData.schedule.days = scheduleDays;
      if (scheduleStart) formData.schedule.start = scheduleStart;
      if (scheduleEnd) formData.schedule.end = scheduleEnd;
    }

    // 급여 정보
    const payType = document.getElementById("pay_type").value;
    const payAmount = document.getElementById("pay_amount").value;

    if (payType || payAmount) {
      formData.pay = {
        type: payType || "negotiable",
        currency: "KRW",
      };
      if (payAmount && payAmount > 0) {
        formData.pay.amount = parseInt(payAmount);
      }
    }

    return formData;
  }

  // 결과 표시
  function displayResult(result) {
    const content = result.content;
    const metadata = result.metadata;

    document.getElementById("generatedTitle").textContent = content.title;
    document.getElementById("generatedSummary").textContent = content.summary;
    document.getElementById("generatedDescription").textContent =
      content.description;

    // 해시태그 표시
    const hashtagsContainer = document.getElementById("generatedHashtags");
    hashtagsContainer.innerHTML = content.hashtags
      .map((tag) => `<span class="badge bg-primary me-1">${tag}</span>`)
      .join("");

    // 메타데이터 표시
    document.getElementById("generatedTime").textContent = new Date(
      metadata.generated_at
    ).toLocaleString();
    document.getElementById("wordCount").textContent = metadata.word_count;

    // 결과 컨테이너 표시
    document.getElementById("resultContainer").style.display = "block";
    document.getElementById("copyBtn").style.display = "block";
  }

  // 클립보드 복사
  function copyToClipboard() {
    const title = document.getElementById("generatedTitle").textContent;
    const summary = document.getElementById("generatedSummary").textContent;
    const description = document.getElementById(
      "generatedDescription"
    ).textContent;
    const hashtags = Array.from(
      document.querySelectorAll("#generatedHashtags .badge")
    )
      .map((badge) => badge.textContent)
      .join(" ");

    const fullText = `${title}\n\n${summary}\n\n${description}\n\n${hashtags}`;

    navigator.clipboard.writeText(fullText).then(() => {
      alert("클립보드에 복사되었습니다!");
    });
  }

  // 데이터 검증
  async function validateData() {
    const formData = collectFormData();

    try {
      const response = await fetch("/api/job-validate", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formData),
      });

      const result = await response.json();

      if (result.success) {
        displayValidationResult(result);
      } else {
        alert("검증 실패: " + result.error);
      }
    } catch (error) {
      alert("검증 중 오류: " + error.message);
    }
  }

  // 검증 결과 표시
  function displayValidationResult(result) {
    const card = document.getElementById("validationCard");
    const scoreElement = document.getElementById("validationScore");
    const issuesElement = document.getElementById("validationIssues");
    const suggestionsElement = document.getElementById("validationSuggestions");

    // 점수 표시
    scoreElement.textContent = result.score;
    scoreElement.className = `badge ${
      result.score >= 80
        ? "bg-success"
        : result.score >= 60
        ? "bg-warning"
        : "bg-danger"
    }`;

    // 문제점 표시
    if (result.issues.length > 0) {
      issuesElement.innerHTML =
        '<h6 class="text-danger">문제점:</h6>' +
        result.issues
          .map((issue) => `<div class="alert alert-danger py-1">${issue}</div>`)
          .join("");
    } else {
      issuesElement.innerHTML = "";
    }

    // 개선 제안 표시
    if (result.suggestions.length > 0) {
      suggestionsElement.innerHTML =
        '<h6 class="text-info">개선 제안:</h6>' +
        result.suggestions
          .map(
            (suggestion) =>
              `<div class="alert alert-info py-1">${suggestion}</div>`
          )
          .join("");
    } else {
      suggestionsElement.innerHTML = "";
    }

    card.style.display = "block";
  }

  // 템플릿 불러오기
  async function loadTemplate() {
    try {
      const response = await fetch("/api/job-templates");
      const result = await response.json();

      if (result.success) {
        displayTemplates(result.templates);
        new bootstrap.Modal(document.getElementById("templateModal")).show();
      }
    } catch (error) {
      alert("템플릿 로드 실패: " + error.message);
    }
  }

  // 템플릿 목록 표시
  function displayTemplates(templates) {
    const container = document.getElementById("templateList");
    container.innerHTML = "";

    Object.entries(templates).forEach(([key, template]) => {
      const div = document.createElement("div");
      div.className = "card mb-2";
      div.innerHTML = `
            <div class="card-body">
                <h6>${template.name}</h6>
                <p class="text-muted small">${template.template.duties}</p>
                <button class="btn btn-sm btn-primary" onclick="applyTemplate('${key}')">
                    이 템플릿 사용
                </button>
            </div>
        `;
      container.appendChild(div);
    });
  }

  // 템플릿 적용
  async function applyTemplate(templateKey) {
    try {
      const response = await fetch("/api/job-templates");
      const result = await response.json();

      if (result.success && result.templates[templateKey]) {
        const template = result.templates[templateKey].template;

        // 폼에 템플릿 데이터 적용
        document.getElementById("title").value = template.title || "";
        document.getElementById("employment_type").value =
          template.employment_type || "";
        document.getElementById("duties").value = template.duties || "";
        document.getElementById("requirements").value =
          template.requirements || "";
        document.getElementById("benefits").value = template.benefits || "";
        document.getElementById("training_provided").checked =
          template.training_provided || false;
        document.getElementById("flexible_time").checked =
          template.flexible_time || false;

        // 모달 닫기
        bootstrap.Modal.getInstance(
          document.getElementById("templateModal")
        ).hide();

        alert("템플릿이 적용되었습니다!");
      }
    } catch (error) {
      alert("템플릿 적용 실패: " + error.message);
    }
  }
</script>
{% endblock %}
